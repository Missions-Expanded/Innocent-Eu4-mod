MSA_start_expedition = {
	if = {
		limit = {
			is_capital = yes
		}
		owner = {
			set_country_flag = MSA_interest
			country_event = { id = ME_Malaya_Events.3 days = $delay$ }
			country_event = { id = ME_Malaya_Events.14 days = 1 random = 14 }
		}
	}
}

# $value$
MSA_change_china_loyalty = {
	change_variable = {
		which = Malaya_china_var
		value = $value$
	}
	
	if = {
		limit = {
			NOT = { has_country_flag = MSA_expedition_tooltip_off }
		}
		custom_tooltip = MSA_current_bonus
		MSA_determine_current_bonus = yes
		MSA_determine_future_bonus = { value = $value$ }
	}
	
	hidden_effect = {
		if = {
			limit = {
				check_variable = {
					which = Malaya_china_var
					value = 100
				}
			}
			set_variable = {
				which = Malaya_china_var
				value = 100
			}
		}
		else_if = {
			limit = {
				NOT = {
					check_variable = {
						which = Malaya_china_var
						value = 0
					}
				}
			}
			set_variable = {
				which = Malaya_china_var
				value = 0
			}
		}
	}
}

MSA_determine_current_bonus = {
	if = {
		limit = {
			check_variable = {
				which = Malaya_china_var
				value = 80
			}
		}
		MSA_absolutely_loyal_bonus = { tooltip = yes }
	}
	else_if = {
		limit = {
			check_variable = {
				which = Malaya_china_var
				value = 60
			}
		}
		MSA_swayed_bonus = { tooltip = yes }
	}
	else_if = {
		limit = {
			check_variable = {
				which = Malaya_china_var
				value = 40
			}
		}
		MSA_neutral_bonus = { tooltip = yes }
	}
	else_if = {
		limit = {
			check_variable = {
				which = Malaya_china_var
				value = 20
			}
		}
		MSA_in_defiance_bonus = { tooltip = yes }
	}
	else = {
		MSA_insulting_bonus = { tooltip = yes }
	}
}

MSA_determine_future_bonus = {
	if = {
		limit = {
			variable_arithmetic_trigger = {
				export_to_variable = {
					which = MSA_temp
					value = 0
				}
				change_variable = {
					which = MSA_temp
					which = Malaya_china_var
				}
				change_variable = {
					which = MSA_temp
					value = $value$
				}
				check_variable = {
					which = MSA_temp
					value = 80
				}
			}
		}
		if = {
			limit = {
				NOT = {
					check_variable = {
						which = Malaya_china_var
						value = 80
					}
				}
			}
			custom_tooltip = MSA_bonus_will_change
			MSA_absolutely_loyal_bonus = { tooltip = yes }
		}
		else = { custom_tooltip = MSA_bonus_no_change }
	}
	else_if = {
		limit = {
			variable_arithmetic_trigger = {
				export_to_variable = {
					which = MSA_temp
					value = 0
				}
				change_variable = {
					which = MSA_temp
					which = Malaya_china_var
				}
				change_variable = {
					which = MSA_temp
					value = $value$
				}
				check_variable = {
					which = MSA_temp
					value = 60
				}
			}
		}
		if = {
			limit = {
				NOT = {
					AND = {
						check_variable = {
							which = Malaya_china_var
							value = 60
						}
						NOT = {
							check_variable = {
								which = Malaya_china_var
								value = 80
							}
						}
					}
				}
			}
			custom_tooltip = MSA_bonus_will_change
			MSA_swayed_bonus = { tooltip = yes }
		}
		else = { custom_tooltip = MSA_bonus_no_change }
	}
	else_if = {
		limit = {
			variable_arithmetic_trigger = {
				export_to_variable = {
					which = MSA_temp
					value = 0
				}
				change_variable = {
					which = MSA_temp
					which = Malaya_china_var
				}
				change_variable = {
					which = MSA_temp
					value = $value$
				}
				check_variable = {
					which = MSA_temp
					value = 40
				}
			}
		}
		if = {
			limit = {
				NOT = {
					AND = {
						check_variable = {
							which = Malaya_china_var
							value = 40
						}
						NOT = {
							check_variable = {
								which = Malaya_china_var
								value = 60
							}
						}
					}
				}
			}
			custom_tooltip = MSA_bonus_will_change
			MSA_neutral_bonus = { tooltip = yes }
		}
		else = { custom_tooltip = MSA_bonus_no_change }
	}
	else_if = {
		limit = {
			variable_arithmetic_trigger = {
				export_to_variable = {
					which = MSA_temp
					value = 0
				}
				change_variable = {
					which = MSA_temp
					which = Malaya_china_var
				}
				change_variable = {
					which = MSA_temp
					value = $value$
				}
				check_variable = {
					which = MSA_temp
					value = 20
				}
			}
		}
		if = {
			limit = {
				NOT = {
					AND = {
						check_variable = {
							which = Malaya_china_var
							value = 20
						}
						NOT = {
							check_variable = {
								which = Malaya_china_var
								value = 40
							}
						}
					}
				}
			}
			custom_tooltip = MSA_bonus_will_change
			MSA_in_defiance_bonus = { tooltip = yes }
		}
		else = { custom_tooltip = MSA_bonus_no_change }
	}
	else = {
		if = {
			limit = {
				NOT = {
					check_variable = {
						which = Malaya_china_var
						value = 20
					}
				}
			}
			custom_tooltip = MSA_bonus_will_change
			MSA_insulting_bonus = { tooltip = yes }
		}
		else = { custom_tooltip = MSA_bonus_no_change }
	}
}

MSA_insulting_bonus = {
	[[tooltip] tooltip = { ]
		
	add_country_modifier = {
		name = MSA_insulting_modifier
		duration = 14600
	}
	set_country_flag = MSA_insulting_flag
	
	[[tooltip] } ]
}

MSA_in_defiance_bonus = {
	[[tooltip] tooltip = { ]
		
	add_country_modifier = {
		name = MSA_in_defiance_modifier
		duration = 10950
	}
	set_country_flag = MSA_in_defiance_flag
	
	[[tooltip] } ]
}

MSA_neutral_bonus = {
	[[tooltip] tooltip = { ]
		
	add_country_modifier = {
		name = MSA_neutral_modifier
		duration = 9125
	}
	set_country_flag = MSA_neutral_flag
	
	[[tooltip] } ]
}

MSA_swayed_bonus = {
	[[tooltip] tooltip = { ]
		
	add_country_modifier = {
		name = MSA_swayed_modifier
		duration = 9125
	}
	set_country_flag = MSA_swayed_flag
	
	[[tooltip] } ]
}

MSA_absolutely_loyal_bonus = {
	[[tooltip] tooltip = { ]
		
	add_country_modifier = {
		name = MSA_loyalty_modifier
		duration = 10950
	}
	set_country_flag = MSA_absolutely_loyal_flag
	[[tooltip] } ]
}

MSA_the_end = {
	clr_country_flag = MSA_chinese_expedition_in_tag
	set_country_flag = MSA_chinese_expedition_concluded
	if = {
		limit = {
			check_variable = {
				which = Malaya_china_var
				value = 80
			}
		}
		MSA_absolutely_loyal_bonus = { }
	}
	else_if = {
		limit = {
			check_variable = {
				which = Malaya_china_var
				value = 60
			}
		}
		MSA_swayed_bonus = { }
	}
	else_if = {
		limit = {
			check_variable = {
				which = Malaya_china_var
				value = 40
			}
		}
		MSA_neutral_bonus = { }
	}
	else_if = {
		limit = {
			check_variable = {
				which = Malaya_china_var
				value = 20
			}
		}
		MSA_in_defiance_bonus = { }
	}
	else = {
		MSA_insulting_bonus = { }
	}
}

#all the randomization and logic behind the events being fired is in the below trigger
MSA_fire_event = {
	random_list = {
		100 = {
			trigger = {
				OR = {
					has_global_flag = MSA_fleet_one
					has_global_flag = MSA_fleet_two
					has_global_flag = MSA_fleet_three
				}
				NOT = { 
					check_variable = { 
						which = Malaya_china_var
						value = 35
					}
				}
				NOT = { num_of_cities = 5 }
				always = no
			}
			country_event = { id = ME_Malaya_Events.9 } #warlike-relations with the expedition, capture.
		}
		1 = {
			country_event = { id = ME_Malaya_Events.20 } #Extradition
		}
		1 = {
			country_event = { id = ME_Malaya_Events.21 } #Scandal at the Court
		}
		1 = {
			trigger = {
				NOT = {
					OR = {
						has_country_modifier = MSA_religion_respected
						has_country_modifier = MSA_religion_not_respected
					}
				}
			}
			country_event = { id = ME_Malaya_Events.22 } #Desecration of a Holy Site
		}
		1 = {
			country_event = { id = ME_Malaya_Events.23 } #Exotic Animals
		}
		1 = {
			country_event = { id = ME_Malaya_Events.24 } #Drunken Sailors
		}
		1 = {
			country_event = { id = ME_Malaya_Events.25 } #Religious Idol
		}
		1 = {
			trigger = {
				NOT = { has_country_modifier = MSA_free_trade }
			}
			country_event = { id = ME_Malaya_Events.26 } #Exploitative Costs
		}
		1 = {
			country_event = { id = ME_Malaya_Events.27 } #Nobles are worried
		}
		1 = {
			country_event = { id = ME_Malaya_Events.28 } #Translator's Dilemma
		}
		1 = {
			country_event = { id = ME_Malaya_Events.29 } #Locals dislike travellers
		}
		1 = {
			country_event = { id = ME_Malaya_Events.30 } #Map Sharing
		}
		1 = {
			country_event = { id = ME_Malaya_Events.31 } #Sailor Impressment
		}
		1 = {
			country_event = { id = ME_Malaya_Events.32 } #Displeased by Quality of Tribute
		}
		1 = {
			trigger = {
				check_variable = { 
					which = Malaya_china_var
					value = 80
				}
			}
			country_event = { id = ME_Malaya_Events.33 } #Hospitality Rewarded
		}
		1 = {
			trigger = {
				NOT = { has_country_modifier = MSA_form_of_defence }
			}
			country_event = { id = ME_Malaya_Events.34 } #Powerful Garrison
		}
		1 = {
			country_event = { id = ME_Malaya_Events.35 } #Displeased by Quality of Tribute
		}
		1 = {
			country_event = { id = ME_Malaya_Events.36 } #Foreign Drill Master
		}
		1 = {
			country_event = { id = ME_Malaya_Events.37 } #Gift - Porcelain
		}
		1 = {
			country_event = { id = ME_Malaya_Events.38 } #Gift - Silk
		}
		1 = {
			trigger = {
				NOT = { has_country_modifier = MSA_losing_wealth }
			}
			country_event = { id = ME_Malaya_Events.39 } #Ship repairs
		}
		1 = {
			country_event = { id = ME_Malaya_Events.40 } #Wisdom of the Generals
		}
		1 = {
			country_event = { id = ME_Malaya_Events.41 } #Invite to Further Travels
		}
		1 = {
			country_event = { id = ME_Malaya_Events.42 } #chinese trading post
		}
		1 = {
			trigger = {
				is_at_war = yes
			}
			country_event = { id = ME_Malaya_Events.43 } #Assistance in War
		}
		1 = {
			trigger = {
				NOT = { had_recent_war = 3 }
				NOT = { has_country_modifier = MSA_peaceful_ways }
			}
			country_event = { id = ME_Malaya_Events.44 } #Peaceful Ways
		}
	}
}

MSA_malay_missions = {
	hidden_effect = {
		complete_mission = MLC_malaya
		complete_mission = MLC_generic_malaya_generic
		complete_mission = PLB_srivijaya
		complete_mission = SUM_generic_alam_melayu 
		complete_mission = MKS_alam_melayu 
		complete_mission = TID_TER_alam_melayu
		complete_mission = PHI_alam_melayu
		complete_mission = BEI_alam_melayu
		complete_mission = PSA_ATJ_alam_melayu
		complete_mission = BEI_generic_alam_melayu
		complete_mission = MAJ_majapahit
		complete_mission = JAV_alam_melayu
		complete_mission = MSA_alam_melayu
	}
	set_country_flag = MSA_workaround #might be useful if above breaks again
	# custom_tooltip = MSA_workaround_set_tt
	change_national_focus_effect = yes
}

MSA_malaya_effect = {
	MSA_malay_missions = yes
	add_country_modifier = {
		name = MSA_malaya_unified
		duration = -1
	}
	custom_tooltip = MSA_accepted_culture_malay 
	tooltip = {
		add_province_modifier = {
			name = MSA_nation_of_malays
			duration = 7300
		}
	}
	hidden_effect = {
		every_owned_province = {
			limit = {
				culture_group = malay
				OR = {
					has_owner_accepted_culture = yes
					has_owner_culture = yes
				}
			}
			add_province_modifier = {
				name = MSA_nation_of_malays
				duration = 7300
			}
		}
	}
}

MSA_claims_java = {
	east_java_area = {
		limit = {
			NOT = { is_core = ROOT }
			NOT = { is_permanent_claim = ROOT }
		}
		add_permanent_claim = ROOT
	}
	central_java_area = {
		limit = {
			NOT = { is_core = ROOT }
			NOT = { is_permanent_claim = ROOT }
		}
		add_permanent_claim = ROOT
	}
	west_java_area = {
		limit = {
			NOT = { is_core = ROOT }
			NOT = { is_permanent_claim = ROOT }
		}
		add_permanent_claim = ROOT
	}
	surabaya_area = {
		limit = {
			NOT = { is_core = ROOT }
			NOT = { is_permanent_claim = ROOT }
		}
		add_permanent_claim = ROOT
	}
	banten_area = {
		limit = {
			NOT = { is_core = ROOT }
			NOT = { is_permanent_claim = ROOT }
		}
		add_permanent_claim = ROOT
	}
}

MSA_claims_borneo = {
	brunei_area = {
		limit = {
			NOT = { is_core = ROOT }
			NOT = { is_permanent_claim = ROOT }
		}
		add_permanent_claim = ROOT
	}
	sabah_area = {
		limit = {
			NOT = { is_core = ROOT }
			NOT = { is_permanent_claim = ROOT }
		}
		add_permanent_claim = ROOT
	}
	kalimantan_area = {
		limit = {
			NOT = { is_core = ROOT }
			NOT = { is_permanent_claim = ROOT }
		}
		add_permanent_claim = ROOT
	}
	palawan_area = {
		limit = {
			NOT = { is_core = ROOT }
			NOT = { is_permanent_claim = ROOT }
		}
		add_permanent_claim = ROOT
	}
	kutai_area = {
		limit = {
			NOT = { is_core = ROOT }
			NOT = { is_permanent_claim = ROOT }
		}
		add_permanent_claim = ROOT
	}
	banjar_area = {
		limit = {
			NOT = { is_core = ROOT }
			NOT = { is_permanent_claim = ROOT }
		}
		add_permanent_claim = ROOT
	}
}

MSA_claims_malaya = {
	malacca_area = {
		limit = {
			NOT = { is_core = ROOT }
			NOT = { is_permanent_claim = ROOT }
		}
		add_permanent_claim = ROOT
	}
	north_malaya_area = {
		limit = {
			NOT = { is_core = ROOT }
			NOT = { is_permanent_claim = ROOT }
		}
		add_permanent_claim = ROOT
	}
	malaya_area = {
		limit = {
			NOT = { is_core = ROOT }
			NOT = { is_permanent_claim = ROOT }
		}
		add_permanent_claim = ROOT
	}
	johor_area = {
		limit = {
			NOT = { is_core = ROOT }
			NOT = { is_permanent_claim = ROOT }
		}
		add_permanent_claim = ROOT
	}
}

MSA_claims_sulawesi = {
	south_sulawesi_area = {
		limit = {
			NOT = { is_core = ROOT }
			NOT = { is_permanent_claim = ROOT }
		}
		add_permanent_claim = ROOT
	}
	sulawesi_area = {
		limit = {
			NOT = { is_core = ROOT }
			NOT = { is_permanent_claim = ROOT }
		}
		add_permanent_claim = ROOT
	}
	makassar_area = {
		limit = {
			NOT = { is_core = ROOT }
			NOT = { is_permanent_claim = ROOT }
		}
		add_permanent_claim = ROOT
	}
}

MSA_claims_sumatra = {
	minangkabau_area = {
		limit = {
			NOT = { is_core = ROOT }
			NOT = { is_permanent_claim = ROOT }
		}
		add_permanent_claim = ROOT
	}
	north_sumatra_area = {
		limit = {
			NOT = { is_core = ROOT }
			NOT = { is_permanent_claim = ROOT }
		}
		add_permanent_claim = ROOT
	}
	south_sumatra_area = {
		limit = {
			NOT = { is_core = ROOT }
			NOT = { is_permanent_claim = ROOT }
		}
		add_permanent_claim = ROOT
	}
	batak_area = {
		limit = {
			NOT = { is_core = ROOT }
			NOT = { is_permanent_claim = ROOT }
		}
		add_permanent_claim = ROOT
	}
	central_sumatra_area = {
		limit = {
			NOT = { is_core = ROOT }
			NOT = { is_permanent_claim = ROOT }
		}
		add_permanent_claim = ROOT
	}
	jambi_area = {
		limit = {
			NOT = { is_core = ROOT }
			NOT = { is_permanent_claim = ROOT }
		}
		add_permanent_claim = ROOT
	}
}

MSA_claims_spice_islands = {
	spice_islands_area = {
		limit = {
			NOT = { is_core = ROOT }
			NOT = { is_permanent_claim = ROOT }
		}
		add_permanent_claim = ROOT
	}
	molluca_area = {
		limit = {
			NOT = { is_core = ROOT }
			NOT = { is_permanent_claim = ROOT }
		}
		add_permanent_claim = ROOT
	}
}

MSA_claims_philippines = {
	southern_luzon_area = {
		limit = {
			NOT = { is_core = ROOT }
			NOT = { is_permanent_claim = ROOT }
		}
		add_permanent_claim = ROOT
	}
	luzon_area = {
		limit = {
			NOT = { is_core = ROOT }
			NOT = { is_permanent_claim = ROOT }
		}
		add_permanent_claim = ROOT
	}
	visayas_area = {
		limit = {
			NOT = { is_core = ROOT }
			NOT = { is_permanent_claim = ROOT }
		}
		add_permanent_claim = ROOT
	}
	mindanao_area = {
		limit = {
			NOT = { is_core = ROOT }
			NOT = { is_permanent_claim = ROOT }
		}
		add_permanent_claim = ROOT
	}
	west_mindanao_area = {
		limit = {
			NOT = { is_core = ROOT }
			NOT = { is_permanent_claim = ROOT }
		}
		add_permanent_claim = ROOT
	}
}

MSA_orang_laut_effect = {
	add_country_modifier = {
		name = MLC_orang_laut_alliances_modifier
		duration = -1
	}
	1361 = {
		add_trade_modifier = {
			who = ROOT
			duration = 5475
			power = 15
			key = MLC_orang_laut
		}
	}
	custom_tooltip = Orang_Laut_events
}

MSA_discover_tiwi = {
	ROOT = { discover_province = 1409 }
	ROOT = { discover_province = 1408 }
	ROOT = { discover_province = 1410 }
	ROOT = { discover_province = 2696 }
	ROOT = { discover_province = 2728 }
	ROOT = { discover_province = 2725 }
	ROOT = { discover_province = 635 }
}

MSA_load_province_flags = {
	if = {
		limit = {
			has_country_flag = TID_TER_can_load_all_provinces
		}
		MSA_load_ternate_claims = { tag = $tag$ }
		MSA_load_tidore_claims = { tag = $tag$ }
	}
	else_if = {
		limit = {
			tag = TID
		}
		MSA_load_tidore_claims = { tag = $tag$ }
	}
	else = {
		MSA_load_ternate_claims = { tag = $tag$ }
	}
}

MSA_load_ternate_claims = {
	648 = { set_province_flag = MSA_$tag$_claim } #shared
	647 = { set_province_flag = MSA_$tag$_claim } #shared
	2696 = { set_province_flag = MSA_$tag$_claim } #shared
	2717 = { set_province_flag = MSA_$tag$_claim } #shared
	645 = { set_province_flag = MSA_$tag$_claim } #shared
	646 = { set_province_flag = MSA_$tag$_claim } #shared
	633 = { set_province_flag = MSA_$tag$_claim }
	4796 = { set_province_flag = MSA_$tag$_claim }
	643 = { set_province_flag = MSA_$tag$_claim }
	2714 = { set_province_flag = MSA_$tag$_claim }
	2713 = { set_province_flag = MSA_$tag$_claim }
	644 = { set_province_flag = MSA_$tag$_claim }
	642 = { set_province_flag = MSA_$tag$_claim }
}

MSA_load_tidore_claims = {
	648 = { set_province_flag = MSA_$tag$_claim } #shared
	647 = { set_province_flag = MSA_$tag$_claim } #shared
	2696 = { set_province_flag = MSA_$tag$_claim } #shared
	2717 = { set_province_flag = MSA_$tag$_claim } #shared
	645 = { set_province_flag = MSA_$tag$_claim } #shared
	646 = { set_province_flag = MSA_$tag$_claim } #shared
	2724 = { set_province_flag = MSA_$tag$_claim }
	2725 = { set_province_flag = MSA_$tag$_claim }
	1245 = { set_province_flag = MSA_$tag$_claim }
	2718 = { set_province_flag = MSA_$tag$_claim }
}
	
MSA_MKS_load_province_flags = {
	4845 = { set_province_flag = MSA_MKS_claim }
	2714 = { set_province_flag = MSA_MKS_claim }
	2713 = { set_province_flag = MSA_MKS_claim }
	4796 = { set_province_flag = MSA_MKS_claim }
	643 = { set_province_flag = MSA_MKS_claim }
	644 = { set_province_flag = MSA_MKS_claim }
	632 = { set_province_flag = MSA_MKS_claim }
}

MSA_MKS_clear_province_flags = {
	4845 = { clr_province_flag = MSA_MKS_claim }
	2714 = { clr_province_flag = MSA_MKS_claim }
	2713 = { clr_province_flag = MSA_MKS_claim }
	4796 = { clr_province_flag = MSA_MKS_claim }
	643 = { clr_province_flag = MSA_MKS_claim }
	644 = { clr_province_flag = MSA_MKS_claim }
	632 = { clr_province_flag = MSA_MKS_claim }
}

MSA_clear_flags = {
	648 = { clr_province_flag = MSA_$tag$_claim } #shared
	647 = { clr_province_flag = MSA_$tag$_claim } #shared
	2696 = { clr_province_flag = MSA_$tag$_claim } #shared
	2717 = { clr_province_flag = MSA_$tag$_claim } #shared
	645 = { clr_province_flag = MSA_$tag$_claim } #shared
	646 = { clr_province_flag = MSA_$tag$_claim } #shared
	2724 = { clr_province_flag = MSA_$tag$_claim }
	2725 = { clr_province_flag = MSA_$tag$_claim }
	1245 = { clr_province_flag = MSA_$tag$_claim }
	2718 = { clr_province_flag = MSA_$tag$_claim }
	633 = { clr_province_flag = MSA_$tag$_claim }
	4796 = { clr_province_flag = MSA_$tag$_claim }
	643 = { clr_province_flag = MSA_$tag$_claim }
	2714 = { clr_province_flag = MSA_$tag$_claim }
	2713 = { clr_province_flag = MSA_$tag$_claim }
	644 = { clr_province_flag = MSA_$tag$_claim }
	642 = { clr_province_flag = MSA_$tag$_claim }
}

MSA_find_provinces_tag = {
	MSA_find_provinces = { target = 1 tag = $tag$ }
	if = {
		limit = { has_country_flag = TID_TER_1_province }
		MSA_find_provinces = { target = 2 tag = $tag$ }
		if = {
			limit = { has_country_flag = TID_TER_2_province }
			MSA_find_provinces = { target = 3 tag = $tag$ }
			if = {
				limit = { has_country_flag = TID_TER_3_province }
				MSA_find_provinces = { target = 4 tag = $tag$ }
				if = {
					limit = { has_country_flag = TID_TER_4_province }
					MSA_find_provinces = { target = 5 tag = $tag$ }
				}
			}
		}
	}
}

MSA_event_87_potential = {
	if = {
		limit = {
			NOT = { has_dlc = "Mandate of Heaven" }
		}
		MSA_87_find_provinces = { target = 1 goods = $goods$ }
		if = {
			limit = { has_country_flag = MSA_1_province }
			MSA_87_find_provinces = { target = 2 goods = $goods$ }
			if = {
				limit = { has_country_flag = MSA_2_province }
				MSA_87_find_provinces = { target = 3 goods = $goods$ }
				if = {
					limit = { has_country_flag = MSA_3_province }
					MSA_87_find_provinces = { target = 4 goods = $goods$ }
					if = {
						limit = { has_country_flag = MSA_1_province }
						MSA_87_find_provinces = { target = 5 goods = $goods$ }
					}
				}
			}
		}
	}
	else = {
		MSA_87_find_provinces = { target = 1 goods = $goods$ }
		if = {
			limit = { has_country_flag = MSA_1_province }
			MSA_87_find_provinces = { target = 2 goods = $goods$ }
			if = {
				limit = { has_country_flag = MSA_2_province }
				MSA_87_find_provinces = { target = 3 goods = $goods$ }
			}
		}
		if = {
			limit = { has_country_flag = MSA_3_province }
			MSA_87_find_provinces_state_edict = { target = 4 goods = $goods$ }
			if = {
				limit = { has_country_flag = MSA_1_province }
				MSA_87_find_provinces_state_edict = { target = 5 goods = $goods$ }
			}
		}
	}
}

MSA_87_find_provinces = {
	random_owned_province = {
		limit = {
			NOT = { has_province_flag = MSA_flag_already_set }
			NOT = { trade_goods = $goods$ }
			NOT = { has_state_edict = edict_advancement_effort }
		}
		save_event_target_as = Malaya_target_$target$
		set_province_flag = MSA_flag_already_set
		ROOT = { set_country_flag =  MSA_$target$_province }
	}
}

MSA_87_find_provinces_state_edict = {
	random_owned_province = {
		limit = {
			NOT = { has_province_flag = MSA_flag_already_set }
			NOT = { trade_goods = $goods$ }
			has_state_edict = edict_advancement_effort
		}
		save_event_target_as = Malaya_target_$target$
		set_province_flag = MSA_flag_already_set
		ROOT = { set_country_flag =  MSA_$target$_province }
	}
}

MSA_87_clr_flags = {
	every_owned_province = {
		clr_province_flag = MSA_flag_already_set
	}
	clr_country_flag = MSA_1_province
	clr_country_flag = MSA_2_province
	clr_country_flag = MSA_3_province
	clr_country_flag = MSA_4_province
	clr_country_flag = MSA_5_province
	clr_country_flag = MSA_cocoa_flag
	clr_country_flag = MSA_coffee_flag
}

MSA_87_execute_effect = {
	if = {
		limit = { has_country_flag = MSA_$id$_province }
		if = { 
			limit = {
				has_country_flag = MSA_cocoa_flag
			}
			event_target:Malaya_target_$id$ = {
				change_trade_goods = cocoa
			}
			hidden_effect = {
				subtract_variable = {
					which = MSA_cocoa_provinces
					value = 1
				}
			}
		}
		else_if = { 
			limit = {
				has_country_flag = MSA_coffee_flag
			}
			event_target:Malaya_target_$id$ = {
				change_trade_goods = coffee
			}
			hidden_effect = {
				subtract_variable = {
					which = MSA_coffee_provinces
					value = 1
				}
			}
		}
	}
}

MSA_find_provinces = {
	random_province = {
		limit = {
			has_province_flag = MSA_$tag$_claim
			is_empty = yes
		}
		save_event_target_as = Malaya_target_$target$
		clr_province_flag = MSA_$tag$_claim
		ROOT = { set_country_flag = TID_TER_$target$_province }
	}
}

MSA_set_up_province_targets = {
	MSA_find_provinces_concession_request = { target = 1 }
	if = {
		limit = { has_country_flag = MSA_1_province }
		MSA_find_provinces_concession_request = { target = 2 }
		if = {
			limit = { has_country_flag = MSA_2_province }
			MSA_find_provinces_concession_request = { target = 3 }
			if = {
				limit = { has_country_flag = MSA_3_province }
				MSA_find_provinces_concession_request = { target = 4 }
				if = {
					limit = { has_country_flag = MSA_4_province }
					MSA_find_provinces_concession_request = { target = 5 }
				}
			}
		}
	}
}

#flags
# MSA_coffee_choice
# MSA_plantation_choice
# 

MSA_execute_province_effect = {
	if = {
		limit = {
			owner = { has_country_flag = MSA_coffee_choice }
		}
		change_trade_goods = coffee
		add_province_modifier = {
			name = MSA_coffee
			duration = -1
		}
		owner = {
			MSA_this_will_cost = { amount = 15 execute = yes }
			set_country_flag = MSA_investment_c_cooldown
		}
	}
	else_if = {
		limit = {
			owner = { has_country_flag = MSA_plantation_choice }
		}
		add_province_modifier = {
			name = MSA_enhanced_spice_production
			duration = -1
		}
		owner = {
			MSA_this_will_cost = { amount = 20 execute = yes }
			set_country_flag = MSA_investment_g_cooldown
		}
	}
	else = {}
	# else_if = {
		# limit = {
			# owner = { has_country_flag = MSA_concession_province }
		# }
		# hidden_effect = {
			# change_variable = {
				# which = ME_Num_of_Foreign_Investments
				# value = -1
			# }
		# }
		
	# }
	
	owner = {
		MSA_clear_flags_province_choice = yes
		hidden_effect = {
			change_variable = {
				which = ME_Num_of_Foreign_Investments
				value = 1
			}
		}
	}
}

MSA_clear_flags_province_choice = {
	clr_country_flag = MSA_coffee_choice
	clr_country_flag = MSA_plantation_choice
	clr_country_flag = MSA_concession_province
	hidden_effect = {
		every_owned_province = {
			clr_province_flag = MSA_flag_already_set
		}
	}
}

MSA_find_provinces_concession_request = {
	if = {
		limit = {
			has_country_flag = MSA_coffee_choice
		}
		random_owned_province = {
			limit = {
				NOT = { has_province_flag = MSA_flag_already_set }
				NOT = { trade_goods = coffee }
				OR = {
					region = malaya_region
					region = indonesia_region
					region = moluccas_region 
				}
			}
			save_event_target_as = Malaya_target_$target$
			set_province_flag = MSA_flag_already_set
			ROOT = { set_country_flag = MSA_$target$_province }
		}
	}
	else_if = {
		limit = {
			has_country_flag = MSA_plantation_choice
		}
		if = {
			limit = {
				is_expanded_mod_active = { mod = trade_goods }
			}
			random_owned_province = {
				limit = {
					NOT = { has_province_flag = MSA_flag_already_set }
					OR = {
						trade_goods = cloves
						trade_goods = spices
						trade_goods = vanilla
						trade_goods = nutmeg
					}
					NOT = { has_province_modifier = MSA_enhanced_spice_production }
				}
				save_event_target_as = Malaya_target_$target$
				set_province_flag = MSA_flag_already_set
				ROOT = { set_country_flag = MSA_$target$_province }
			}
		}
		else = {
			random_owned_province = {
				limit = {
					NOT = { has_province_flag = MSA_flag_already_set }
					OR = {
						trade_goods = cloves
						trade_goods = spices
					}
					NOT = { has_province_modifier = MSA_enhanced_spice_production }
				}
				save_event_target_as = Malaya_target_$target$
				set_province_flag = MSA_flag_already_set
				ROOT = { set_country_flag = MSA_$target$_province }
			}
		}
	}
	else_if = {
		limit = {
			has_country_flag = MSA_concession_province
		}
		random_owned_province = {
			limit = {
				NOT = { has_province_flag = MSA_flag_already_set }
				province_has_center_of_trade_of_level = 1
			}
			save_event_target_as = Malaya_target_$target$
			set_province_flag = MSA_flag_already_set
			ROOT = { set_country_flag = MSA_$target$_province }
		}
	}
}

MSA_TID_TER_cost = { #funny. I use this for more than TID TER!
	if = {
		limit = {
			check_variable = { which = MSA_num_of_colonies value = 1 }
		}
		if = {
			limit = {
				check_variable = { which = MSA_num_of_colonies value = 2 }
			}
			if = {
				limit = {
					check_variable = { which = MSA_num_of_colonies value = 3 }
				}
				if = {
					limit = {
						check_variable = { which = MSA_num_of_colonies value = 4 }
					}
					add_treasury = -150
				}
				else = { add_treasury = -125 }
			}
			else = { add_treasury = -100 }
		}
		else = { add_treasury = -75 }
	}
	else = { add_treasury = -50 }
	
	hidden_effect = {
		change_variable = {
			which = MSA_num_of_colonies
			value = 1
		}
	}
	clr_country_flag = TID_TER_flicked_decision
	set_country_flag = TID_TER_flicked_decision
}

MSA_sumatra_reward = {
	add_mercantilism = 2
	add_country_modifier = {
		name = MSA_legacy_of_srivijaya
		duration = 7300
	}
}

MSA_borneo_reward = {
	add_navy_tradition = 10
	add_country_modifier = {
		name = MSA_bruneian_thalassocracy_distrubed
		duration = 7300
	}
}

MSA_sulawesi_reward = {
	add_prestige_or_monarch_power = { amount = 10 }
	add_country_modifier = {
		name = MSA_island_of_iron
		duration = 9125
	}
}

MSA_java_reward = {
	add_army_tradition_or_mil_power = { amount = 10 }
	add_country_modifier = {
		name = MSA_majapahit_defeated
		duration = 10950
	}
}

MSA_malaya_reward = {
	add_stability_or_adm_power = yes
	1361 = {
		add_trade_modifier = {
			who = ROOT
			duration = 9125
			power = 25
			key = MSA_strait_secured
		}
	}
}

BEI_modifier_extension = {
	custom_tooltip = BEI_extend_or_add_humble_rise
	hidden_effect = {
		if = {
			limit = {
				any_owned_province = {
					has_province_modifier = BEI_humble_rise_to_greatness
				}
			}
			random_owned_province = {
				limit = {
					has_province_modifier = BEI_humble_rise_to_greatness
				}
				extend_province_modifier = {
					name = BEI_humble_rise_to_greatness
					duration = 3650
				}
			}
		}
		else = {
			capital_scope = {
				add_province_modifier = {
					name = BEI_humble_rise_to_greatness
					duration = 3650
				}
			}
		}
	}
}

PSA_ATJ_modifier_extension = {
	custom_tooltip = PSA_ATJ_extend_holy_war
	hidden_effect = {
		if = {
			limit = {
				any_owned_province = {
					has_province_modifier = PSA_ATJ_holy_war
				}
			}
			random_owned_province = {
				limit = {
					has_province_modifier = PSA_ATJ_holy_war
				}
				extend_province_modifier = {
					name = PSA_ATJ_holy_war
					duration = 3650
				}
			}
		}
		else = {
			capital_scope = {
				add_province_modifier = {
					name = PSA_ATJ_holy_war
					duration = 3650
				}
			}
		}
	}
}

MSA_spread_of_islam_route_spread = {
	set_global_flag = MSA_am_I_executed #we will use this flag to check if the algorithm produced a result for a province. If it will return negative, then the province will be marked as unavailable to save performance
	random_province = {
		limit = {
			province_has_center_of_trade_of_level = 1
			has_port = yes
			religion_group = muslim
			MSA_affected_by_spread_of_islam = yes
			OR = {
				NOT = { has_province_flag = MSA_spread_failed }
				had_province_flag = {
					flag = MSA_spread_failed
					days = 18250
				}
			}
		}
		
		save_event_target_as = MSA_origin_province_religion
		
		every_province = {
			limit = {
				province_has_center_of_trade_of_level = 1
				has_port = yes
				NOT = { religion_group = muslim }
				NOT = {
					province_distance = {
						who = PREV
						distance = 150 #number about right.
					}
				}
				MSA_affected_by_spread_of_islam = yes
				NOT = { 
					owner = {
						OR = {
							has_country_flag = MAJ_immunity_from_spread
							has_country_flag = MSA_restricted_trade_flag
						}
					}
				}
			}
			set_province_flag = MSA_in_reach
			clr_global_flag = MSA_am_I_executed
		}
		
		if = {
			limit = {
				has_global_flag = MSA_am_I_executed #we failed.
			}
			clr_global_flag = MSA_am_I_executed
			set_province_flag = MSA_spread_failed
			MSA_spread_of_islam_normal_spread = yes
		}
		else = {
			random_province = {
				limit = {
					has_province_flag = MSA_in_reach
				}
				save_event_target_as = MSA_target_province_religion
			}
			every_province = {
				limit = {
					has_province_flag = MSA_in_reach
				}
				clr_province_flag = MSA_in_reach
			}
		}
	}
}

MSA_spread_of_islam_normal_spread = { #land spread
	random_province = {
		limit = {
			religion_group = muslim
			MSA_affected_by_spread_of_islam = yes #areas and regions affected by malayan spread of islam
			any_neighbor_province = {
				NOT = { religion_group = muslim }
				NOT = { 
					owner = {
						OR = {
							has_country_flag = MAJ_immunity_from_spread
							has_country_flag = MSA_restricted_trade_flag
						}
					}
				}
			}
		}
		save_event_target_as = MSA_origin_province_religion
		random_neighbor_province = {
			limit = {
				NOT = { religion_group = muslim }
				NOT = { 
					owner = {
						OR = {
							has_country_flag = MAJ_immunity_from_spread
							has_country_flag = MSA_restricted_trade_flag
						}
					}
				}
			}
			save_event_target_as = MSA_target_province_religion
		}
	}
}

MSA_christian_spread_animist_dharmic = { #common spread, in the provinces not converted by islam yet
	set_global_flag = MSA_am_I_executed
	random_owned_province = {
		limit = {
			NOT = { religion_group = christian }
			OR = {
				religion_group = pagan
				religion_group = dharmic
			}
			culture_group = malay
		}
		save_event_target_as = MSA_province
		clr_global_flag = MSA_am_I_executed
	}
	
	random_owned_province = {
		limit = {
			NOT = { religion_group = christian }
			OR = {
				religion_group = pagan
				religion_group = dharmic
			}
			province_has_center_of_trade_of_level = 1
			culture_group = malay
		}
		save_event_target_as = MSA_province
		clr_global_flag = MSA_am_I_executed
	}
	
	if = {
		limit = { 
			has_global_flag = MSA_am_I_executed
		}
		clr_global_flag = MSA_am_I_executed
		MSA_christian_spread_center = yes
	}
}

MSA_christian_spread_center = { #the other spread.
	random_owned_province = {
		limit = {
			NOT = { religion_group = christian }
			culture_group = malay
			province_has_center_of_trade_of_level = 1
		}
		save_event_target_as = MSA_province
	}
	if = {
		limit = {
			if = {
				limit = { has_global_flag = MSA_spread_of_christianity_slow }
				num_of_owned_provinces_with = {
					religion_group = christian
					value = 6
				}
			}
			else = {
				num_of_owned_provinces_with = {
					religion_group = christian
					value = 12
				}
			}
		}
		clr_global_flag = MSA_spread_of_christianity
		country_event = { id = ME_Malaya_Events.77 }
	}
}

MSA_this_will_cost = {
	custom_tooltip = MSA_this_will_cost_$amount$
	[[execute]
		hidden_effect = {
			subtract_variable = {
				which = MSA_foreign_investment_amount
				value = $amount$
			}
		}
	]
}

MSA_find_lowest_tech_effect = {
	export_to_variable = {
		which = MSA_our_adm_tech
		value = trigger_value:adm_tech
	}
	export_to_variable = {
		which = MSA_our_dip_tech
		value = trigger_value:dip_tech
	}
	export_to_variable = {
		which = MSA_our_mil_tech
		value = trigger_value:mil_tech
	}
	set_variable = {
		which = MSA_our_lowest_tech
		which = MSA_our_adm_tech
	}
	if = {
		limit = {
			NOT = {
				check_variable = {
					which = MSA_our_dip_tech
					which = MSA_our_lowest_tech
				}
			}
		}
		set_variable = {
			which = MSA_our_lowest_tech
			which = MSA_our_dip_tech
		}
	}
	if = {
		limit = {
			NOT = {
				check_variable = {
					which = MSA_our_mil_tech
					which = MSA_our_lowest_tech
				}
			}
		}
		set_variable = {
			which = MSA_our_lowest_tech
			which = MSA_our_mil_tech
		}
	}
	
	subtract_variable = {
		which = MSA_our_adm_tech
		which = MSA_our_lowest_tech
	}
	subtract_variable = {
		which = MSA_our_dip_tech
		which = MSA_our_lowest_tech
	}
	subtract_variable = {
		which = MSA_our_mil_tech
		which = MSA_our_lowest_tech
	}
	
	if = {
		limit = {
			is_variable_equal = {
				which = MSA_our_adm_tech
				value = 0
			}
		}
		if = {
			limit = {
				is_variable_equal = {
					which = MSA_our_dip_tech
					value = 0
				}
			}
			if = {
				limit = {
					is_variable_equal = {
						which = MSA_our_mil_tech
						value = 0
					}
				}
				add_adm_power = 40
				add_dip_power = 40
				add_mil_power = 40
			}
			else = {
				add_adm_power = 60
				add_dip_power = 60
			}
		}
		else = {
			if = {
				limit = {
					is_variable_equal = {
						which = MSA_our_mil_tech
						value = 0
					}
				}
				add_adm_power = 60
				add_mil_power = 60
			}
			else = {
				add_adm_power = 120
			}
		}
	}
	else = {
		if = {
			limit = {
				is_variable_equal = {
					which = MSA_our_dip_tech
					value = 0
				}
			}
			if = {
				limit = {
					is_variable_equal = {
						which = MSA_our_mil_tech
						value = 0
					}
				}
				add_dip_power = 60
				add_mil_power = 60
			}
			else = {
				add_dip_power = 120
			}
		}
		else = {
			add_mil_power = 120
		}
	}
	
	#flush the vars
	set_variable = {
		which = MSA_our_adm_tech
		value = 0
	}
	set_variable = {
		which = MSA_our_dip_tech
		value = 0
	}
	set_variable = {
		which = MSA_our_mil_tech
		value = 0
	}
	set_variable = {
		which = MSA_our_lowest_tech
		value = 0
	}
}

MSA_expand_canton_effect = {
	if = {
		limit = {
			check_variable = {
				which = MSA_community_size
				value = 15
			}
		}
		add_mercantilism = 2
	}
	else = {
		custom_tooltip = MSA_cantonese_community_will_grow
		if = {
			limit = {
				check_variable = {
					which = MSA_community_size
					value = 14
				}
			}
			2160 = { #14
				add_permanent_province_modifier = {
					name = MSA_malay_community
					duration = -1
				}
			}
		}
		else_if = {
			limit = {
				check_variable = {
					which = MSA_community_size
					value = 13
				}
			}
			2153 = { #14
				add_permanent_province_modifier = {
					name = MSA_malay_community
					duration = -1
				}
			}
		}
		else_if = {
			limit = {
				check_variable = {
					which = MSA_community_size
					value = 12
				}
			}
			2163 = { #13
				add_permanent_province_modifier = {
					name = MSA_malay_community
					duration = -1
				}
			}
		}
		else_if = {
			limit = {
				check_variable = {
					which = MSA_community_size
					value = 11
				}
			}
			670 = { #12
				add_permanent_province_modifier = {
					name = MSA_malay_community
					duration = -1
				}
			}
		}
		else_if = {
			limit = {
				check_variable = {
					which = MSA_community_size
					value = 10
				}
			}
			669 = { #11
				add_permanent_province_modifier = {
					name = MSA_malay_community
					duration = -1
				}
			}
		}
		else_if = {
			limit = {
				check_variable = {
					which = MSA_community_size
					value = 9
				}
			}
			2164 = { #10
				add_permanent_province_modifier = {
					name = MSA_malay_community
					duration = -1
				}
			}
		}
		else_if = {
			limit = {
				check_variable = {
					which = MSA_community_size
					value = 8
				}
			}
			666 = { #9
				add_permanent_province_modifier = {
					name = MSA_malay_community
					duration = -1
				}
			}
		}
		else_if = {
			limit = {
				check_variable = {
					which = MSA_community_size
					value = 7
				}
			}
			1840 = { #8
				add_permanent_province_modifier = {
					name = MSA_malay_community
					duration = -1
				}
			}
		}
		else_if = {
			limit = {
				check_variable = {
					which = MSA_community_size
					value = 6
				}
			}
			1829 = { #7
				add_permanent_province_modifier = {
					name = MSA_malay_community
					duration = -1
				}
			}
		}
		else_if = {
			limit = {
				check_variable = {
					which = MSA_community_size
					value = 5
				}
			}
			2156 = { #6
				add_permanent_province_modifier = {
					name = MSA_malay_community
					duration = -1
				}
			}
		}
		else_if = {
			limit = {
				check_variable = {
					which = MSA_community_size
					value = 4
				}
			}
			2162 = { #5
				add_permanent_province_modifier = {
					name = MSA_malay_community
					duration = -1
				}
			}
		}
		else_if = {
			limit = {
				check_variable = {
					which = MSA_community_size
					value = 3
				}
			}
			2161 = { #4
				add_permanent_province_modifier = {
					name = MSA_malay_community
					duration = -1
				}
			}
		}
		else_if = {
			limit = {
				check_variable = {
					which = MSA_community_size
					value = 2
				}
			}
			2159 = { #3
				add_permanent_province_modifier = {
					name = MSA_malay_community
					duration = -1
				}
			}
		}
		else_if = {
			limit = {
				check_variable = {
					which = MSA_community_size
					value = 1
				}
			}
			2158 = { #2
				add_permanent_province_modifier = {
					name = MSA_malay_community
					duration = -1
				}
			}
		}
		else = {
			2157 = { #1
				add_permanent_province_modifier = {
					name = MSA_malay_community
					duration = -1
				}
			}
		}
		hidden_effect = {
			change_variable = {
				which = MSA_community_size
				value = 1
			}
		}
	}
}

MSA_shrink_canton_effect = {
	if = {
		limit = {
			NOT = {
				check_variable = {
					which = MSA_community_size
					value = 1
				}
			}
		}
		add_mercantilism = -2
	}
	else = {
		custom_tooltip = MSA_cantonese_community_will_shrink
		if = {
			limit = {
				check_variable = {
					which = MSA_community_size
					value = 14
				}
			}
			2160 = { #14
				remove_province_modifier = MSA_malay_community
			}
		}
		else_if = {
			limit = {
				check_variable = {
					which = MSA_community_size
					value = 13
				}
			}
			2153 = { #14
				remove_province_modifier = MSA_malay_community
			}
		}
		else_if = {
			limit = {
				check_variable = {
					which = MSA_community_size
					value = 12
				}
			}
			2163 = { #13
				remove_province_modifier = MSA_malay_community
			}
		}
		else_if = {
			limit = {
				check_variable = {
					which = MSA_community_size
					value = 11
				}
			}
			670 = { #12
				remove_province_modifier = MSA_malay_community
			}
		}
		else_if = {
			limit = {
				check_variable = {
					which = MSA_community_size
					value = 10
				}
			}
			669 = { #11
				remove_province_modifier = MSA_malay_community
			}
		}
		else_if = {
			limit = {
				check_variable = {
					which = MSA_community_size
					value = 9
				}
			}
			2164 = { #10
				remove_province_modifier = MSA_malay_community
			}
		}
		else_if = {
			limit = {
				check_variable = {
					which = MSA_community_size
					value = 8
				}
			}
			666 = { #9
				remove_province_modifier = MSA_malay_community
			}
		}
		else_if = {
			limit = {
				check_variable = {
					which = MSA_community_size
					value = 7
				}
			}
			1840 = { #8
				remove_province_modifier = MSA_malay_community
			}
		}
		else_if = {
			limit = {
				check_variable = {
					which = MSA_community_size
					value = 6
				}
			}
			1829 = { #7
				remove_province_modifier = MSA_malay_community
			}
		}
		else_if = {
			limit = {
				check_variable = {
					which = MSA_community_size
					value = 5
				}
			}
			2156 = { #6
				remove_province_modifier = MSA_malay_community
			}
		}
		else_if = {
			limit = {
				check_variable = {
					which = MSA_community_size
					value = 4
				}
			}
			2162 = { #5
				remove_province_modifier = MSA_malay_community
			}
		}
		else_if = {
			limit = {
				check_variable = {
					which = MSA_community_size
					value = 3
				}
			}
			2161 = { #4
				remove_province_modifier = MSA_malay_community
			}
		}
		else_if = {
			limit = {
				check_variable = {
					which = MSA_community_size
					value = 2
				}
			}
			2159 = { #3
				remove_province_modifier = MSA_malay_community
			}
		}
		else_if = {
			limit = {
				check_variable = {
					which = MSA_community_size
					value = 1
				}
			}
			2158 = { #2
				remove_province_modifier = MSA_malay_community
			}
		}
		else = {
			2157 = { #1
				remove_province_modifier = MSA_malay_community
			}
		}
		hidden_effect = {
			subtract_variable = {
				which = MSA_community_size
				value = 1
			}
		}
	}
}

MSA_colonies_in_borneo = {
	2706 = {
		if = {
			limit = { is_empty = yes }
			add_siberian_construction = 100
		}
		else = { add_core = ROOT }
	}
	2708 = {
		if = {
			limit = { is_empty = yes }
			add_siberian_construction = 100
		}
		else = { add_core = ROOT }
	}
}